<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>אליפות הסולפג' – הימורים</title>
  <style>
    body { font-family: system-ui, Arial; margin: 16px; line-height: 1.35; }
    .card { border: 1px solid #ddd; border-radius: 16px; padding: 14px; margin: 12px 0; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    h2 { font-size: 16px; margin: 0 0 10px; }
    label { display: block; margin: 10px 0 6px; }
    select, input { width: 100%; padding: 10px; border-radius: 12px; border: 1px solid #ccc; }
    button { padding: 12px 14px; border-radius: 14px; border: 1px solid #111; background: #111; color: #fff; width: 100%; font-size: 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .muted { color: #666; font-size: 13px; }
    .ok { color: #0a7; }
    .err { color: #c33; }
  </style>
</head>
<body>
  <h1>אליפות הסולפג' – טופס הימורים</h1>
  <div class="muted">ממלאים בתים → האתר בונה רבעים/חצאים/גמר → שולחים.</div>

  <div class="card">
    <h2>פרטים</h2>
    <label>שם התלמיד/ה</label>
    <input id="studentName" placeholder="למשל: אמה" />
  </div>

  <div class="card">
    <h2>שלב הבתים</h2>
    <div id="groups"></div>
    <div class="muted">בכל בית לבחור מקום 1 ומקום 2 (לא אותו שם פעמיים).</div>
  </div>

  <div class="card">
    <h2>רבע גמר (נבנה אוטומטית)</h2>
    <div id="quarters"></div>
  </div>

  <div class="card">
    <h2>חצי גמר</h2>
    <div id="semis"></div>
  </div>

  <div class="card">
    <h2>גמר + אלוף</h2>
    <div id="finals"></div>
  </div>

  <div class="card">
    <button id="submitBtn">שלח הימורים</button>
    <div id="status" class="muted" style="margin-top:10px;"></div>
  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzUUMWe05a3P9fNpkc2j4xDOetdOcVSk9VBdcAIkx6IgSHhosWD9BvpExdYOagCiFVU/exec";

// בתים (לפי החלוקה שביצענו קודם בשיחה)
const HOUSES = {
  "בית א׳": ["אורי גולן","סתיו","יהונתן","אביתר"],
  "בית ב׳": ["אמה","דריה","אורי לנקרי","איתמר"],
  "בית ג׳": ["עופר","אביב","איתי","יהלי"],
  "בית ד׳": ["אמילי","אריאל","לינוי"]
};

// מבנה רבעים לפי הקובץ שלך: 1א-2ג, 2א-1ג, 1ב-2ד, 1ד-2ב
const QUARTER_RULES = [
  { id:"QF1", title:"רבע גמר 1", a:{house:"בית א׳", pos:1}, b:{house:"בית ג׳", pos:2} },
  { id:"QF2", title:"רבע גמר 2", a:{house:"בית א׳", pos:2}, b:{house:"בית ג׳", pos:1} },
  { id:"QF3", title:"רבע גמר 3", a:{house:"בית ב׳", pos:1}, b:{house:"בית ד׳", pos:2} },
  { id:"QF4", title:"רבע גמר 4", a:{house:"בית ד׳", pos:1}, b:{house:"בית ב׳", pos:2} },
];

const state = {
  groups: {},   // { "בית א׳": {1:"...",2:"..."} }
  quarters: {}, // { QF1:"winner", ... }
  semis: {},    // { SF1:"winner", SF2:"winner" }
  finals: {},   // { F:"winner", CHAMP:"winner" }
};

function el(tag, attrs={}, children=[]) {
  const n = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v]) => (k==="class") ? n.className=v : n.setAttribute(k,v));
  (Array.isArray(children)?children:[children]).forEach(c => n.appendChild(typeof c==="string"?document.createTextNode(c):c));
  return n;
}

function makeSelect(options, placeholder="בחר") {
  const s = el("select");
  s.appendChild(el("option",{value:""}, placeholder));
  options.forEach(o => s.appendChild(el("option",{value:o}, o)));
  return s;
}

function renderGroups() {
  const root = document.getElementById("groups");
  root.innerHTML = "";
  Object.keys(HOUSES).forEach(house => {
    const card = el("div",{class:"card"});
    card.appendChild(el("h2",{}, house));

    const row = el("div",{class:"row"});
    const s1 = makeSelect(HOUSES[house], "מקום 1");
    const s2 = makeSelect(HOUSES[house], "מקום 2");

    s1.addEventListener("change", () => {
      state.groups[house] = state.groups[house] || {};
      state.groups[house][1] = s1.value;
      validateHouse(house, s1, s2);
      renderAllBrackets();
    });
    s2.addEventListener("change", () => {
      state.groups[house] = state.groups[house] || {};
      state.groups[house][2] = s2.value;
      validateHouse(house, s1, s2);
      renderAllBrackets();
    });

    row.appendChild(el("div",{}, [el("label",{}, "מקום 1"), s1]));
    row.appendChild(el("div",{}, [el("label",{}, "מקום 2"), s2]));
    card.appendChild(row);
    root.appendChild(card);
  });
}

function validateHouse(house, s1, s2) {
  if (s1.value && s2.value && s1.value === s2.value) {
    alert(`ב${house} אי אפשר לבחור את אותו שם גם מקום 1 וגם מקום 2`);
    s2.value = "";
    state.groups[house][2] = "";
  }
}

function getPos(house, pos) {
  return (state.groups[house] && state.groups[house][pos]) ? state.groups[house][pos] : "";
}

function renderQuarters() {
  const root = document.getElementById("quarters");
  root.innerHTML = "";

  QUARTER_RULES.forEach(q => {
    const a = getPos(q.a.house, q.a.pos);
    const b = getPos(q.b.house, q.b.pos);
    const players = [a,b].filter(Boolean);

    const card = el("div",{class:"card"});
    card.appendChild(el("h2",{}, `${q.title}: ${a||"?"} מול ${b||"?"}`));

    const sel = makeSelect(players.length?players:[], "בחר מנצח");
    sel.value = state.quarters[q.id] || "";
    sel.disabled = players.length !== 2;

    sel.addEventListener("change", () => {
      state.quarters[q.id] = sel.value;
      renderSemis();
      renderFinals();
    });

    card.appendChild(sel);
    root.appendChild(card);
  });
}

function renderSemis() {
  const root = document.getElementById("semis");
  root.innerHTML = "";

  const sf1Players = [state.quarters.QF1, state.quarters.QF2].filter(Boolean);
  const sf2Players = [state.quarters.QF3, state.quarters.QF4].filter(Boolean);

  const sf1 = el("div",{class:"card"});
  sf1.appendChild(el("h2",{}, `חצי גמר 1: ${sf1Players[0]||"?"} מול ${sf1Players[1]||"?"}`));
  const sf1Sel = makeSelect(sf1Players.length===2?sf1Players:[], "בחר מנצח");
  sf1Sel.value = state.semis.SF1 || "";
  sf1Sel.disabled = sf1Players.length !== 2;
  sf1Sel.addEventListener("change", ()=>{ state.semis.SF1 = sf1Sel.value; renderFinals(); });
  sf1.appendChild(sf1Sel);

  const sf2 = el("div",{class:"card"});
  sf2.appendChild(el("h2",{}, `חצי גמר 2: ${sf2Players[0]||"?"} מול ${sf2Players[1]||"?"}`));
  const sf2Sel = makeSelect(sf2Players.length===2?sf2Players:[], "בחר מנצח");
  sf2Sel.value = state.semis.SF2 || "";
  sf2Sel.disabled = sf2Players.length !== 2;
  sf2Sel.addEventListener("change", ()=>{ state.semis.SF2 = sf2Sel.value; renderFinals(); });
  sf2.appendChild(sf2Sel);

  root.appendChild(sf1);
  root.appendChild(sf2);
}

function renderFinals() {
  const root = document.getElementById("finals");
  root.innerHTML = "";

  const finalists = [state.semis.SF1, state.semis.SF2].filter(Boolean);

  const f = el("div",{class:"card"});
  f.appendChild(el("h2",{}, `גמר: ${finalists[0]||"?"} מול ${finalists[1]||"?"}`));
  const fSel = makeSelect(finalists.length===2?finalists:[], "בחר מנצח");
  fSel.value = state.finals.F || "";
  fSel.disabled = finalists.length !== 2;
  fSel.addEventListener("change", ()=>{ state.finals.F = fSel.value; renderChampion(); });
  f.appendChild(fSel);

  const champ = el("div",{class:"card"});
  champ.appendChild(el("h2",{}, "אלוף/ה"));
  const champSel = makeSelect(state.finals.F ? [state.finals.F] : [], "ננעל אחרי בחירת מנצח בגמר");
  champSel.value = state.finals.CHAMP || "";
  champSel.disabled = !state.finals.F;
  champSel.addEventListener("change", ()=>{ state.finals.CHAMP = champSel.value; });
  champ.appendChild(champSel);

  root.appendChild(f);
  root.appendChild(champ);
}

function renderChampion() {
  // כשהגמר נבחר, ננעל האלוף אוטומטית
  state.finals.CHAMP = state.finals.F || "";
  renderFinals();
}

function renderAllBrackets() {
  renderQuarters();
  renderSemis();
  renderFinals();
}

function readyToSubmit() {
  const name = document.getElementById("studentName").value.trim();
  if (!name) return "חסר שם תלמיד/ה.";
  // אפשר להקשיח (לדרוש שכל הבתים מלאים וכו’) אם תרצה
  return "";
}

async function submit() {
  const status = document.getElementById("status");
  status.textContent = "";
  status.className = "muted";

  const problem = readyToSubmit();
  if (problem) {
    status.textContent = problem;
    status.className = "err";
    return;
  }

  const payload = {
    studentName: document.getElementById("studentName").value.trim(),
    groups: state.groups,
    quarters: state.quarters,
    semis: state.semis,
    finals: state.finals
  };

  try {
    status.textContent = "שולח…";
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const json = await res.json().catch(()=>({}));
    if (!res.ok || !json.ok) throw new Error("Bad response");
    status.textContent = "נשלח בהצלחה ✅";
    status.className = "ok";
  } catch (e) {
    status.textContent = "שליחה נכשלה. בדוק שהדבקת נכון את SCRIPT_URL ושפרסת את ה-Web App כ-Anyone.";
    status.className = "err";
  }
}

document.getElementById("submitBtn").addEventListener("click", submit);

renderGroups();
renderAllBrackets();
</script>
</body>
</html>
